var LocationModel=function(marker){var self=this;this.marker=marker;this.icon=ko.observable(marker.getIcon());this.title=ko.observable(marker.getTitle());this.lat=ko.observable(marker.getPosition().lat());this.lng=ko.observable(marker.getPosition().lng());this.city=ko.observable("");this.state=ko.observable("");this.country=ko.observable("");this.currentTemp=ko.observable("");this.locText=ko.computed(function(){return this.city();},this);this.radarMap=ko.observable("");this.isSaved=ko.observable("");this.windowContent=ko.observable("");this.hasOpenWindow=false;this.saveData=ko.computed(function(){return{lat:this.lat(),lng:this.lng(),city:this.city(),state:this.state(),country:this.country(),radarSrc:this.radarMap(),windowContent:this.windowContent()};},this);};var locationViewModel=function(){var self=this;this.arrHitTimes=[];this.markerList=ko.observableArray([]);this.saveAll=ko.observableArray([]);this.selectedMarker=ko.observable();this.saveImage="images/icn_save_small.png";this.storageObj="locationInfo";this.wu_key="d208634303ed569d";this.google_key="AIzaSyDWLOC6K3kwBnBnp_15oNgkuTjzZ87Fl_I";this.defaultLat=ko.observable(-34.397);this.defaultLng=ko.observable(150.644);this.init=function(){self.loadMapSrc();};this.loadMarkers=function(){if(!localStorage.locationInfo){localStorage.locationInfo=JSON.stringify([]);}if(!localStorage.wuLastUpdated){localStorage.wuLastUpdated=JSON.stringify([]);}self.arrHitTimes=JSON.parse(localStorage.wuLastUpdated);var storedInfo=JSON.parse(localStorage.locationInfo);for(var i=0;i<storedInfo.length;i++){console.log("Getting Location info for: "+storedInfo[i].city);var marker=new google.maps.Marker({position:{lat:storedInfo[i].lat,lng:storedInfo[i].lng},map:self.map});var location=self.addLocation(marker);location.lat(storedInfo[i].lat);location.lng(storedInfo[i].lng);location.city(storedInfo[i].city);location.state(storedInfo[i].state);location.country(storedInfo[i].country);location.radarMap(storedInfo[i].radarSrc);location.windowContent(storedInfo[i].windowContent);location.isSaved(true);location.icon(self.saveImage);self.saveAll.push(location.saveData());marker.setIcon(location.icon());}if(self.markerList().length>0){self.selectMarker(self.markerList()[0]);}};this.selectMarker=function(currentMarker){self.selectedMarker().hasOpenWindow=false;self.mapInfoWindow.close();self.selectedMarker(currentMarker);self.map.setCenter(currentMarker.marker.getPosition());self.getLocationInfo(currentMarker);};this.listChange=function(obj,event){if(event.originalEvent){self.selectMarker(self.selectedMarker());}};this.saveAllMarkers=function(){for(var i=0;i<self.markerList().length;i++){if(self.saveAll.indexOf(self.markerList()[i].saveData())<0){self.markerList()[i].icon(self.saveImage);self.markerList()[i].isSaved(true);self.markerList()[i].marker.setIcon(self.markerList()[i].icon());self.saveAll.push(self.markerList()[i].saveData());}}localStorage.setItem(self.storageObj,ko.toJSON(self.saveAll()));};this.saveSelectedMarker=function(){if(self.saveAll.indexOf(self.selectedMarker().saveData())<0){self.selectedMarker().marker.setIcon(self.saveImage);self.selectedMarker().isSaved(true);self.saveAll.push(self.selectedMarker().saveData());localStorage.setItem(self.storageObj,ko.toJSON(self.saveAll()));}};this.removeAllMarkers=function(){for(var i=0;i<self.markerList().length;i++){self.markerList()[i].marker.setMap(null);}self.markerList([]);self.saveAll([]);localStorage.locationInfo=JSON.stringify([]);};this.removeSelectedMarker=function(){self.selectedMarker().marker.setMap(null);if(self.saveAll.indexOf(self.selectedMarker().saveData())>=0){self.saveAll.remove(self.selectedMarker().saveData());localStorage.setItem(self.storageObj,ko.toJSON(self.saveAll()));}self.markerList.remove(self.selectedMarker());};this.notSaved=ko.computed(function(){return(self.selectedMarker())?!self.selectedMarker().isSaved():true;});this.srchTxt=ko.observable("");this.clearFilter=function(){self.srchTxt("");};this.visibleOptions=ko.computed(function(){if(self.markerList().length>0){return ko.utils.arrayFilter(self.markerList(),function(item){var visible=(item.windowContent().replace(/(<[^>]*>)/g,"").toLowerCase().indexOf(self.srchTxt().toLowerCase())>=0);item.marker.setVisible(visible);if(!visible&&item.hasOpenWindow){item.hasOpenWindow=false;self.mapInfoWindow.close();}return visible;});}});this.mapInfoWindow;this.mapErrorTxt=ko.observable("");this.mapSrc=ko.observable("");this.loadMapSrc=function(){console.log("Fetching map src");try{self.mapSrc("https://maps.googleapis.com/maps/api/js?key="+self.google_key+"&callback=viewModel.loadMap");}catch(err){console.log("error getting src");}};this.loadMap=function(){console.log("loading map");try{this.mapOptions={center:{lat:self.defaultLat(),lng:self.defaultLng()},zoom:8};self.map=new google.maps.Map(document.getElementById("mainMap"),this.mapOptions);self.mapInfoWindow=new google.maps.InfoWindow();google.maps.event.addListener(self.mapInfoWindow,"domready",function(){ko.applyBindings(self,document.getElementById("buttonContainer"));});google.maps.event.addListener(self.map,"click",function(event){var marker=new google.maps.Marker({position:event.latLng,map:self.map});var location=self.addLocation(marker);self.selectMarker(location);});self.loadMarkers();}catch(err){alert("We are having trouble loading the map. Please reload the page to try again");console.log("Error: "+err);}};this.addLocation=function(marker){var location=new LocationModel(marker);self.markerList.push(location);google.maps.event.addListener(marker,"click",function(event){self.selectMarker(location);});return location;};this.setLocationContent=function(marker){marker.windowContent(getMarkerContent());};this.getLocationInfo=function(currentMarker){var makeCall=false;var now=new Date().getTime();if(self.arrHitTimes.length<10){makeCall=true;}if((self.arrHitTimes.length==10)&&(now-self.arrHitTimes[0]>60000)){makeCall=true;self.arrHitTimes.shift();}if(makeCall){console.log("url: "+"http://api.wunderground.com/api/d208634303ed569d/features/conditions/q/"+currentMarker.lat()+","+currentMarker.lng()+".json");$.ajax({url:"http://api.wunderground.com/api/"+self.wu_key+"/features/conditions/q/"+currentMarker.lat()+","+currentMarker.lng()+".json",dataType:"jsonp",success:function(parsed_json){var doSave=false;if(self.saveAll.indexOf(currentMarker.saveData())>=0){self.saveAll.remove(currentMarker.saveData());doSave=true;}if(currentMarker.city()==""){currentMarker.city(parsed_json["current_observation"]["display_location"]["city"]);currentMarker.state(parsed_json["current_observation"]["display_location"]["state_name"]);currentMarker.country(parsed_json["current_observation"]["display_location"]["country_iso3166"]);}currentMarker.currentTemp(parsed_json["current_observation"]["temp_f"]);var radarUrl="http://api.wunderground.com/api/"+self.wu_key+"/radar/image.gif?centerlat="+currentMarker.lat()+"&centerlon="+currentMarker.lng()+"&radius=100&width=100&height=100&newmaps=1";currentMarker.radarMap(radarUrl);self.mapInfoWindow.setContent(getWindowContent());self.setLocationContent(currentMarker);self.mapInfoWindow.open(self.map,currentMarker.marker);currentMarker.hasOpenWindow=true;if(doSave){self.saveAll.push(currentMarker.saveData());localStorage.setItem(self.storageObj,ko.toJSON(self.saveAll()));}},error:function(){console.log("Ajax error thrown");}}).fail(function(jqXHR,textStatus){console.log("Ajax failed: "+textStatus);});self.arrHitTimes.push(new Date().getTime());console.log("New timestamp array: "+self.arrHitTimes);localStorage.setItem("wuLastUpdated",ko.toJSON(self.arrHitTimes));}else{if(currentMarker.city()!=""){self.mapInfoWindow.open(self.map,currentMarker.marker);}console.log("Not making call - too many hits/min: "+(now-self.arrHitTimes[0])+" - "+self.arrHitTimes);}};};var viewModel=new locationViewModel();ko.applyBindings(viewModel);window.onload=viewModel.init();console.log("app.js done.");function getMarkerContent(){return $(".windowContent").html();}function getWindowContent(){return $(".windowContainer").html();}